<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pesquisa da B√≠blia</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìñ Sistema de Pesquisa da B√≠blia</h1>
            <p>Explore as Escrituras Sagradas</p>
        </div>

        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="Digite sua pesquisa aqui..." />
                <button id="searchBtn" class="search-btn">üîç Pesquisar</button>
            </div>

            <div class="book-selector">
                <select id="bookSelect" class="book-select">
                    <option value="">Selecione um livro...</option>
                </select>
                <select id="chapterSelect" class="chapter-select">
                    <option value="">Selecione um cap√≠tulo...</option>
                </select>
                <button id="loadChapterBtn" class="search-btn">Carregar Cap√≠tulo</button>
            </div>
        </div>

        <div class="content">
            <div id="chapterTitle" class="chapter-title"></div>
            <div id="contentArea"></div>
        </div>
    </div>

    <script>
        let bibleData = [];
        let currentSearchResults = [];
        let loadedBooks = new Set(); // Para rastrear quais livros j√° foram carregados

        // Carrega a B√≠blia da API espec√≠fica com carregamento otimizado
        async function loadBible() {
            try {
                showLoading();
                
                // Usando CORS proxy apenas se necess√°rio
                const apiUrl = '/acf.json';
                let response;
                
                try {
                    // Tentativa direta primeiro
                    response = await fetch(apiUrl);
                    if (!response.ok) throw new Error('Resposta n√£o OK');
                } catch (error) {
                    // Se falhar, tenta com proxy CORS
                    console.log('Tentando com proxy CORS...');
                    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(apiUrl);
                    response = await fetch(proxyUrl);
                }
                
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    bibleData = data;
                    populateBookSelector();
                    
                    // Carrega apenas G√™nesis inicialmente
                    await loadInitialContent();
                }
            } catch (error) {
                console.error('Erro ao carregar a B√≠blia:', error);
                showError();
            }
        }

        // Carrega o conte√∫do inicial (G√™nesis 1)
        async function loadInitialContent() {
            const genesisIndex = bibleData.findIndex(book => book.abbrev === 'Gn');
            if (genesisIndex !== -1) {
                loadedBooks.add(genesisIndex); // Marca como carregado
                const genesisBook = bibleData[genesisIndex];
                displayChapter(genesisBook, 0, 'G√™nesis');
            }
        }

        // Popula o seletor de livros
        function populateBookSelector() {
            const bookSelect = document.getElementById('bookSelect');
            bookSelect.innerHTML = '<option value="">Selecione um livro...</option>';
            
            bibleData.forEach((book, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = getFullBookName(book.abbrev);
                bookSelect.appendChild(option);
            });
        }

        // Retorna o nome completo do livro
        function getFullBookName(abbrev) {
            const bookNames = {
                'Gn': 'G√™nesis', 'Ex': '√äxodo', 'Lv': 'Lev√≠tico', 'Nm': 'N√∫meros', 'Dt': 'Deuteron√¥mio',
                'Js': 'Josu√©', 'Jz': 'Ju√≠zes', 'Rt': 'Rute', '1Sm': '1 Samuel', '2Sm': '2 Samuel',
                '1Rs': '1 Reis', '2Rs': '2 Reis', '1Cr': '1 Cr√¥nicas', '2Cr': '2 Cr√¥nicas', 'Ed': 'Esdras',
                'Ne': 'Neemias', 'Et': 'Ester', 'J√≥': 'J√≥', 'Sl': 'Salmos', 'Pv': 'Prov√©rbios',
                'Ec': 'Eclesiastes', 'Ct': 'Cantares', 'Is': 'Isa√≠as', 'Jr': 'Jeremias', 'Lm': 'Lamenta√ß√µes',
                'Ez': 'Ezequiel', 'Dn': 'Daniel', 'Os': 'Os√©ias', 'Jl': 'Joel', 'Am': 'Am√≥s',
                'Ob': 'Obadias', 'Jn': 'Jonas', 'Mq': 'Miqu√©ias', 'Na': 'Naum', 'Hc': 'Habacuque',
                'Sf': 'Sofonias', 'Ag': 'Ageu', 'Zc': 'Zacarias', 'Ml': 'Malaquias', 'Mt': 'Mateus',
                'Mc': 'Marcos', 'Lc': 'Lucas', 'Jo': 'Jo√£o', 'At': 'Atos', 'Rm': 'Romanos',
                '1Co': '1 Cor√≠ntios', '2Co': '2 Cor√≠ntios', 'Gl': 'G√°latas', 'Ef': 'Ef√©sios', 'Fp': 'Filipenses',
                'Cl': 'Colossenses', '1Ts': '1 Tessalonicenses', '2Ts': '2 Tessalonicenses', '1Tm': '1 Tim√≥teo',
                '2Tm': '2 Tim√≥teo', 'Tt': 'Tito', 'Fm': 'Filemom', 'Hb': 'Hebreus', 'Tg': 'Tiago',
                '1Pe': '1 Pedro', '2Pe': '2 Pedro', '1Jo': '1 Jo√£o', '2Jo': '2 Jo√£o', '3Jo': '3 Jo√£o',
                'Jd': 'Judas', 'Ap': 'Apocalipse'
            };
            return bookNames[abbrev] || abbrev;
        }

        // Popula o seletor de cap√≠tulos
        function populateChapterSelector(bookIndex) {
            const chapterSelect = document.getElementById('chapterSelect');
            chapterSelect.innerHTML = '<option value="">Selecione um cap√≠tulo...</option>';
            
            if (bookIndex !== '' && bibleData[bookIndex]) {
                const chapters = bibleData[bookIndex].chapters;
                for (let i = 0; i < chapters.length; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Cap√≠tulo ${i + 1}`;
                    chapterSelect.appendChild(option);
                }
            }
        }

        // Exibe um cap√≠tulo
        function displayChapter(book, chapterIndex, bookName) {
            const chapter = book.chapters[chapterIndex];
            const chapterTitle = document.getElementById('chapterTitle');
            const contentArea = document.getElementById('contentArea');
            
            chapterTitle.textContent = `${bookName} - Cap√≠tulo ${chapterIndex + 1}`;
            
            let html = '';
            chapter.forEach((verse, index) => {
                html += `
                    <div class="verse">
                        <span class="verse-number">${index + 1}</span>
                        <span class="verse-text">${verse}</span>
                    </div>
                `;
            });
            
            contentArea.innerHTML = html;
        }

        // Realiza pesquisa
        function performSearch(searchTerm) {
            if (!searchTerm.trim()) {
                alert('Digite um termo para pesquisar');
                return;
            }

            showLoading('Pesquisando...');
            currentSearchResults = [];
            
            const searchTermLower = searchTerm.toLowerCase();
            
            // Como todos os dados j√° est√£o carregados, pesquisamos diretamente
            bibleData.forEach((book) => {
                const bookName = getFullBookName(book.abbrev);
                
                book.chapters.forEach((chapter, chapterIndex) => {
                    chapter.forEach((verse, verseIndex) => {
                        if (verse.toLowerCase().includes(searchTermLower)) {
                            currentSearchResults.push({
                                book: bookName,
                                chapter: chapterIndex + 1,
                                verse: verseIndex + 1,
                                text: verse,
                                searchTerm: searchTerm
                            });
                        }
                    });
                });
            });
            
            displaySearchResults();
        }

        // Exibe resultados da pesquisa
        function displaySearchResults() {
            const chapterTitle = document.getElementById('chapterTitle');
            const contentArea = document.getElementById('contentArea');
            
            if (currentSearchResults.length === 0) {
                chapterTitle.textContent = 'Nenhum resultado encontrado';
                contentArea.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Tente outros termos de pesquisa.</p>';
                return;
            }
            
            chapterTitle.textContent = `Resultados da Pesquisa (${currentSearchResults.length} encontrados)`;
            
            let html = '';
            currentSearchResults.forEach((result) => {
                const highlightedText = highlightSearchTerm(result.text, result.searchTerm);
                html += `
                    <div class="search-result-item">
                        <div class="result-reference">${result.book} ${result.chapter}:${result.verse}</div>
                        <div class="result-text">${highlightedText}</div>
                    </div>
                `;
            });
            
            contentArea.innerHTML = html;
        }

        // Destaca o termo pesquisado
        function highlightSearchTerm(text, searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // Mostra indicador de carregamento
        function showLoading(message = 'Carregando...') {
            document.getElementById('contentArea').innerHTML = 
                `<div class="loading">‚è≥ ${message}</div>`;
        }

        // Mostra mensagem de erro
        function showError() {
            document.getElementById('contentArea').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h2 style="color: #e74c3c;">Erro ao carregar a B√≠blia</h2>
                    <p style="color: #7f8c8d;">N√£o foi poss√≠vel carregar os dados da API.</p>
                    <button onclick="location.reload()" class="search-btn" style="margin-top: 15px;">Tentar Novamente</button>
                </div>
            `;
        }

        // Event Listeners
        document.getElementById('searchBtn').addEventListener('click', () => {
            const searchTerm = document.getElementById('searchInput').value;
            performSearch(searchTerm);
        });

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = document.getElementById('searchInput').value;
                performSearch(searchTerm);
            }
        });

        document.getElementById('bookSelect').addEventListener('change', (e) => {
            const bookIndex = e.target.value;
            if (bookIndex !== '') {
                loadedBooks.add(parseInt(bookIndex)); // Marca como carregado
                populateChapterSelector(bookIndex);
            }
        });

        document.getElementById('loadChapterBtn').addEventListener('click', () => {
            const bookIndex = document.getElementById('bookSelect').value;
            const chapterIndex = document.getElementById('chapterSelect').value;
            
            if (bookIndex !== '' && chapterIndex !== '') {
                const book = bibleData[bookIndex];
                const bookName = getFullBookName(book.abbrev);
                displayChapter(book, parseInt(chapterIndex), bookName);
            } else {
                alert('Selecione um livro e um cap√≠tulo');
            }
        });

        // Carrega a B√≠blia ao iniciar a p√°gina
        window.addEventListener('load', loadBible);
    </script>

<footer style="background: linear-gradient(45deg, #2c3e50, #3498db); color: white; text-align: center; padding: 20px; border-top-left-radius: 20px; border-top-right-radius: 20px; margin-top: 40px;">
    <p>&copy; Sistema de Pesquisa da B√≠blia | Desenvolvido por <a href="https://septuaginta.com.br/" target="_blank" style="color: #f1c40f; text-decoration: none;">Septuaginta.com.br</a></p>
    <p>Todos os direitos reservados.</p>
</footer>
</body>
</html>
